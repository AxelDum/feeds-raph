<%#
 Copyright 2015 DUPONCHEEL Sebastien <sebastien.duponcheel@ovh.net>
-%>
<%
	local uci = require("luci.model.uci").cursor()

	local device_id		= uci:get("overthebox", "me", "device_id")
	local service_id	= uci:get("overthebox", "me", "service")
	local has_service_confirmation = false
	if uci:get("overthebox", "me", "askserviceconfirmation") == "1" then
		has_service_confirmation = true
	end
%>

<%+header%>

<script type="text/javascript" src="<%=resource%>/seedrandom.js"></script>
<script type="text/javascript">//<![CDATA[
	/* Over_The_Box Step bar */
	var stepbar = {
		register:	{ status: 'todo', caption: "<%:Register%>" },
		activate:	{ status: 'todo', caption: "<%:Activate%>" },
		dhcp:		{ status: 'todo', caption: "<%:OverTheBox DHCP%>" },
		remoteDhcp:	{ status: 'todo', caption: "<%:Gateways DHCP%>" },
		securedNetwork:	{ status: 'todo', caption: "<%:Secured Network%>" },
	}
	function refreshStepBar()
	{
		var status = document.getElementById('overthebox_status_bar');
		if(status)
		{
			var nstep  = Object.keys(stepbar).length;
			var html = '<ol class="progtrckr" data-progtrckr-steps="'+ nstep +'">'
			for (stepname in stepbar) {
				html += String.format('<li class="progtrckr-%s">%s</li>', stepbar[stepname].status, stepbar[stepname].caption)
			}
			html += '</ol>';
			status.innerHTML = html;
		}
	}
	window.setInterval("refreshStepBar()", 1000);

	function stringToColour(str) {
		if(str == "free1")
			return "FireBrick";
		if(str == "ovh1")
			return "DeepSkyBlue";
		if(str == "ovh2")
			return "LightGreen";
	        if(str == "if1")
	            return "PaleGreen";
	        if(str == "if2")
	            return "PowderBlue";
	        if(str == "if3")
	            return "Salmon";
	        if(str == "if4")
	            return "SeaGreen";
	        if(str == "if5")
	            return "PaleTurquoise";
	        // Generate a color folowing the name
	        Math.seedrandom(str);
	        var rand = Math.random() * Math.pow(255,3);
	        Math.seedrandom(); // don't leave a non-random seed in the generator
	        for (var i = 0, colour = "#"; i < 3; colour += ("00" + ((rand >> i++ * 8) & 0xFF).toString(16)).slice(-2));
	        return colour;
	}
//]]></script>
<style type="text/css">
// Progess bar CSS
ol.progtrckr {
    margin: 0;
    padding: 0;
    list-style-type none;
}

ol.progtrckr li {
    display: inline-block;
    text-align: center;
    line-height: 3em;
}

ol.progtrckr[data-progtrckr-steps="2"] li { width: 49%; }
ol.progtrckr[data-progtrckr-steps="3"] li { width: 33%; }
ol.progtrckr[data-progtrckr-steps="4"] li { width: 24%; }
ol.progtrckr[data-progtrckr-steps="5"] li { width: 19%; }
ol.progtrckr[data-progtrckr-steps="6"] li { width: 16%; }
ol.progtrckr[data-progtrckr-steps="7"] li { width: 14%; }
ol.progtrckr[data-progtrckr-steps="8"] li { width: 12%; }
ol.progtrckr[data-progtrckr-steps="9"] li { width: 11%; }

ol.progtrckr li.progtrckr-error {
    color: black;
    border-bottom: 4px solid red;
}
ol.progtrckr li.progtrckr-done {
    color: black;
    border-bottom: 4px solid yellowgreen;
}
ol.progtrckr li.progtrckr-doing {
    color: black;
    border-bottom: 4px solid orange;
}
ol.progtrckr li.progtrckr-warn {
    color: black;
    border-bottom: 4px solid orangered;
}
ol.progtrckr li.progtrckr-todo {
    color: silver;
    border-bottom: 4px solid silver;
}

ol.progtrckr li:after {
    content: "\00a0\00a0";
}
ol.progtrckr li:before {
    position: relative;
    bottom: -2.5em;
    float: left;
    left: 50%;
    line-height: 1em;
}
ol.progtrckr li.progtrckr-done:before {
    content: "\2713";
    color: white;
    background-color: yellowgreen;
    height: 1.2em;
    width: 1.2em;
    line-height: 1.2em;
    border: none;
    border-radius: 1.2em;
}
ol.progtrckr li.progtrckr-doing:before {
    content: "\27F2";
    color: orange;
    background-color: white;
    font-size: 1.5em;
    bottom: -1.6em;
    border: none;
    border-radius: 1.2em;
}
ol.progtrckr li.progtrckr-warn:before {
    content: "\26A0";
    color: orangered;
    background-color: white;
    font-size: 1.5em;
    bottom: -1.6em;
    border: none;
    border-radius: 1.2em;
}
ol.progtrckr li.progtrckr-todo:before {
    content: "\039F";
    color: silver;
    background-color: white;
    font-size: 1.5em;
    bottom: -1.6em;
}
ol.progtrckr li.progtrckr-error:before {
    content: "\2716";
    color: red;
    background-color: white;
    font-size: 1.5em;
    bottom: -1.6em;
    border: none;
    border-radius: 1.2em;
}
</style>

<!-- Display the general status bar -->
<h2><a id="content" name="content"><%:OverTheBox overview%></a></h2>
<div id="overthebox_status_bar"></div>
<%
if not service_id then
	include("overthebox/register")
elseif has_service_confirmation then
	%>
	<script type="text/javascript">
		stepbar.register.status = "done";
		stepbar.activate.status = "warn";
	</script>
	<%
	include("overthebox/activate")
else
	%>
		<fieldset class="cbi-section">
		<!--	<legend><%:OverTheBox overview%></legend> -->
			<table width="100%" cellspacing="10">
				<tr><td width="33%"><%:Device ID%></td><td><%=device_id or "?"%></td></tr>
				<% if service_id then %>
				<tr><td width="33%"><%:Service name%></td><td><%=service_id or "?"%></td></tr>
				<% end %>
			</table>
		</fieldset>
	<%
	if device_id and service_id then
	%>
		<script type="text/javascript">
			stepbar.activate.status = "done";
			stepbar.register.status = "done";
		</script>
	<%
		include("overthebox/dhcpwizard")
		include("overthebox/wanstatus")
		include("overthebox/realtimegraphs")
		include("overthebox/dhcpleases")
	else
        %>
                <script type="text/javascript">
			stepbar.activate.caption = "<%:Register%>";
			stepbar.activate.status = "error";
		</script>
        <%
	end
end
%>

<%+footer%>

